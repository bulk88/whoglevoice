<html manifest="ac.appcache"><head>
<link rel="preconnect" href="https://www.googleapis.com" crossorigin>
<link rel="preconnect" href="//carrier.natasha.cat">
<link rel="preconnect" href="https://content-people-pa.googleapis.com" crossorigin>
<link rel="preconnect" href="https://p.saproxy.us.to">
<meta name="mobileoptimized" content="0" charset=utf-8>
<style>body{margin-top:0px;}button{line-height:1.5}</style>
</head>
<script src="client.js" type="text/javascript"></script>
<script>
//adds preconnects
initLnkFmt();
var pendingNameReqs = 0;
var d;/*didEarlyFetch*/

//finish(err, resp)
function getThreadList(fullreq, paginationToken, archive, finish){
    getAuthToken(function(tok) {getThreadList_t(true, tok, fullreq, paginationToken, archive, finish)});
}
function getThreadList_t(canReAuth, tok, fullreq, paginationToken, archive, finish){
var x=new XMLHttpRequest;
x.open("POST","https://www.googleapis.com/voice/v1/voiceclient/api2thread/list?alt="+(fullreq?"json&prettyPrint=false":"protojson"),1);
x.setRequestHeader("Content-Type", "application/json+protobuf");
x.setRequestHeader("Authorization","Bearer "+tok);
x.onreadystatechange=function(){if(x.readyState==4){
    if(x.status == 503) { //temorary random failure, just retry
        getThreadList_t(canReAuth, tok, fullreq, paginationToken, archive, finish);
    }
    else if(canReAuth && x.status == 401 && resp401Unauth(x.response)){
        wvWipeAuthToken();
        getAuthToken(function(tok) {getThreadList_t(false, tok, fullreq, paginationToken, archive, finish)});
    }
    else if(x.status != 200) {
        x.status != 401 && alert("status: "+x.status+"\nresp:"+x.response);
        finish(x.response||-1); /* opera 12 for 401 has empty x.response, mk fake error */
    }
    else {finish(false, fullreq ? JSON.parse(x.response) : x.response)};
}};

//x.send('[1, 10, 15, null, "v1-0-1594212530956000", [null, true, true]]');
//arg 1 is thread types, call or sms to return, 0 invalid arg err,
// 2 is SMS only, 1 is SMS and calls 3 is calls only, 4 is voicemail
// 5 is spam folder texts, 6 is archive folder texts
//7 is invalid arg
//arg 2 is how many of the you want, how many numbers {
 // "id": "t.+13475551234",
 // "read": true,
 // "view": [
 //  "ALL_THREADS",
 //  "TEXT_THREADS"
 // ]
 //},
 //arg 3 is how many text messages you want from each number, 0 or more
 //arg 4 pagenation token, "15XXXX" timestamp string type or null
 //arg 5 is "version_token": "v1-0-1594212659066000" but no visible output change if I add it
//extra struct elements not needed
//x.send('[2, 100, 1, null, null, [null, true, true]]');
x.send((fullreq?'['+(archive?6:2)+',100,1':'['+(archive?6:2)+',1,1')+(paginationToken?',"'+paginationToken+'"]':']'));
}

/*getThreadListUI(evt)*/
function g(evt) {
evt = evt.target;
evt.textContent ="\xa0\u25BD\u231B";
var contact_cache,
  paginationToken = (evt.dataset||{}).wvPgTok;
//even on virgin page load, we still do tiny net req/full net req, not straight
//to full network req
//because old HTML code and base page aren't done parsing yet and threadList
//DIV doesn't exist yet

/*            Full req Flag   pag token num */
getThreadList(paginationToken,paginationToken,sessionStorage.getItem('wvArchView'),function(e,r){
    if (e) { /*error*/
        evt.textContent ="\xa0\u25BD\u2718";//X mark
    }
    else {
        if(paginationToken) {
            drawThdList(paginationToken,r,contact_cache);
        } else {
            var tdiv = document.getElementById('threadList');
            //lastest server MID doesn't match local MID aka new msg
            var oldmid = tdiv.firstChild && tdiv.firstChild.dataset.wvMid;
            if(r.substr(25,40) != oldmid) {
                getThreadList(1,0,sessionStorage.getItem('wvArchView'),function(e,r){
                    if (e) { /*error*/
                        evt.textContent ="\xa0\u25BD\u2718";//X mark
                    }
                    else {
                        drawThdList(0,r,contact_cache);
                        evt.textContent ="\xa0\u25BD\u2714";//Good mark
                    }
                }); //build while idle waiting on IO
                contact_cache = buildContactCache();
            //no update needed
            } else {
                evt.textContent ="\xa0\u25BD\u2714";//Good mark
                for(var e, t, i=0; i < tdiv.children.length; i++) {
                  e = tdiv.children[i];
                  if( e.nodeName === 'DIV') { //skip button element
                    //div left tag, a tag
                    e = e.firstChild.firstChild;
                    t = e.firstChild; //text node of A tag
                    //retry fetch contact names, for tels for all cached draws
                    //localstorage cached view might be partial contact names
                    //if very fast user navigate thd list->thd view b4 all contact name
                    //load over the wire
                    if (t.nodeValue.match(/^\+\d+$/)) {
                      (function(e,t){ //mk closure for var e
                      pendingNameReqs++;
                      getContactName(t.nodeValue.substring(2), function(err, r) {
                      pendingNameReqs--;
                      //undefined or "[]" on wire if no match
                      if (r) {
                          //avoid repaint, 99% cached so block doesn't run
                          if(t.nodeValue !== r[0]) {
                            t.nodeValue = r[0];
                          }
                          e.setAttribute('data-pid', r[1]);
                          r[2] && e.setAttribute('data-url', r[2]);
                          r[3] && e.setAttribute('data-lec', r[3]);
                          if (!pendingNameReqs) {
                              localStorage.setItem(sessionStorage.getItem('wvArchView')
                                ? 'wvThdListA' : 'wvThdListM', document.getElementById('threadList').innerHTML);
                          }
                      }
                      });
                      })(e,t); //mk closure for var e
                    }
                  }
                }
            }
        }
    }
});
if(paginationToken) {//build while idle waiting on IO
  contact_cache = buildContactCache();
}
}

function refreshNoUI() {
    g({target:{textContent: 0}})
}

if(lazySignedInEmail()){
    d = 1;
    refreshNoUI();
}
</script>
<body>
<!--button is UI spacer, jerk between index.html and thread.html-->
Welcome To Whogle Voice<button style="visibility:hidden">B</button>
<div id='sign-in-bar'></div>
<!--all 1 line on purpose, dont add newlines-->
<button title="Refresh" style="width:4em;height:2em;text-align:left;" onclick='g(event)'>&nbsp;&#x25BD;</button>
<label><input title="Archive" type="checkbox" id="archive"
onchange="
  sessionStorage.setItem('wvArchView',this.checked ? '1' : '');
  document.getElementById('threadList').innerHTML = localStorage.getItem(this.checked?'wvThdListA':'wvThdListM');
  //trigger refresh with UI effects
  var b = this.parentNode.previousSibling.previousSibling;
  b.onclick({target:b})"/>A</label>
<!-- do not add whitespace btwn input and button -->
<input type=tel placeholder="New num here" size=10></input><button onclick='window.location="thread.html#"+c(event.target.previousSibling.value)'>&#x3164;Go #&#x3164;</button>
<div id='threadList'></div>
<script>
/*cleanTelNum*/
function c(t) {
    return /1?\(?([0-9]{3})\)?[-.\s]?([0-9]{3})[-.\s]?([0-9]{4})/.exec(t)[0].replace(/\D/g, '').substr(-10, 10);
}

function buildContactCache() {
  var i = 0,
  contact_cache = {},
  name,
  n,
  //build cache old HTML view contact names, anti UI jerk, 99% accurate
  arr = document.getElementById('threadList').querySelectorAll('a');
  for (; i < arr.length; i++) {
    n = arr[i];
    name = n.firstChild.nodeValue;
    //dont add 5 digit codes
    if (!name.match(/^\+?\d+$/)) {
      contact_cache['+1' + n.hash.slice(1)] = name;
    }
  }
  return contact_cache;
}

function drawThdList(paginationToken,r,contact_cache) {
    var av_list_type = sessionStorage.getItem('wvArchView')
      ? 'wvThdListA' : 'wvThdListM';
    var frag = document.createDocumentFragment();
    if (r.paginationToken) {
        var moreButton = document.createElement('button');
        moreButton.textContent = "\xa0Load More\xa0";
        //survive serialization of HTML
        moreButton.dataset.wvPgTok = r.paginationToken;
        moreButton.setAttribute('onclick', "g(event)");
    }
    r = r.thread;
    for(var i=0;i<r.length; i++){
        //p=paragraph
        var p = document.createElement('div');
        var msgObj = r[i].item[0];
        if (!i)p.dataset.wvMid = msgObj.id;

        frag.appendChild(p);
        if(msgObj.isArtificialErrorMessage) {
            p.style.backgroundColor = 'red';
        } else {
            p.style.outline = '1px solid black';
        }
        var n = p.appendChild(document.createElement('div'));
        n.align = 'left';
        n = n.appendChild(document.createElement('a'));
        var name = msgObj.contact.phoneNumber;
        if (name.length === 12 && name[0] === '+' && name[1] === '1') {
          name = name.slice(2);
        }
        n.href = 'thread.html#'+name;
        name = msgObj.contact.name;
        //use cached name for UI jerk, maybe updated in some ms later below
        //dont copy data-* or A element direct, incase old data-* missing
        //from fresh contact API fetch, attr was deleted for example, this
        //could be fixed in future by removeAttribute || setAttribute
        //but I'm lazy, virgin A tag, so use textContent, not nodeValue
        n.textContent = contact_cache[name] ? contact_cache[name] : name;
        if (name.match(/^\+\d+$/)) {
            (function(e){
            pendingNameReqs++;
            getContactName(name.substring(2), function(err, r) {
            pendingNameReqs--;
            //undefined or "[]" on wire if no match
            if (r) {
                //avoid repaint, 99% cached so block doesn't run
                if(e.firstChild.nodeValue !== r[0]) {
                  e.firstChild.nodeValue = r[0];
                }
                e.setAttribute('data-pid', r[1]);
                r[2] && e.setAttribute('data-url', r[2]);
                r[3] && e.setAttribute('data-lec', r[3]);
                if(pendingNameReqs===0) {
                    localStorage.setItem(av_list_type, document.getElementById('threadList').innerHTML);
                }
            }
            });
            })(n);
        }
        n = p.appendChild(document.createElement('div'));
        n.align = msgObj.type == "smsIn" ? 'left' : 'right';
        n.textContent = msgObj.mmsMessage ? '[IMG]'+msgObj.mmsMessage.text : msgObj.messageText;
    }
    moreButton && frag.appendChild(moreButton);
    var tdiv = document.getElementById('threadList');
    if (paginationToken) {
        tdiv.replaceChild(frag, tdiv.lastChild);
    } else {
        while (tdiv.lastChild) {
            tdiv.removeChild(tdiv.lastChild);
        }
        tdiv.appendChild(frag);
        localStorage.setItem(av_list_type, tdiv.innerHTML);
    }
}

(function(){ /*var e can't be global*/
        var av = sessionStorage.getItem('wvArchView');
        document.getElementById('archive').checked = av;
        document.getElementById('threadList').innerHTML = localStorage.getItem(av?'wvThdListA':'wvThdListM');
        var p = navigator.clipboard;
        if(p && p.readText) { /* old browser or HTTPS failure */
        var e = document;
        e = e.body.insertBefore(e.createElement('button'), e.getElementById('threadList'));
        e.textContent = '\u3164Paste\u3164';
        e.onclick  = function (){
            p.readText()
            .then(function(t){
                window.location = "thread.html#"+c(t);
            })
        };
    }

    drawLoginBar();
})();
/*if not logged in, the conditional paste button can't render/JS throw error missing node */
d || refreshNoUI();
window.ononline = refreshNoUI;
</script>
</body></html>
