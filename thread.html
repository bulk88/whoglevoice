<html><head><meta name="mobileoptimized" content="0"></head>
<body>
<script src="client.js" type="text/javascript"></script>
Welcome To Whogle Voice
<div id='sign-in-bar'></div>
<div id='buddy-bar'></div>
<div id='thread'></div>
<script>
function getConvoUI(t) {
    getThread(t, function(err,r){
        if (err) {
            try {
                r = JSON.parse(err);
                if(r.error.code == 404
                    && r.error.message == 'voice_error: {"error_code":"NOT_FOUND"}') {
                    frag.textContent = "Thread not found. Send the first Message."
                }
            } catch (e) {
            alert("Error getting thread:\n\n"+err);
            }
        } else {
        var userIndex = lazySignedInUserIndex();
        var frag = document.createDocumentFragment();
        var i;
        for(i=0;i<r.thread.item.length; i++){
            var p = document.createElement('p');
            var msgObj = r.thread.item[i];
            if (msgObj.mms_message) {
                if (msgObj.mms_message.attachment.length != 1) {
                    alert('Error: trying to draw Picture message "'
                    +msgObj.message_text+'" but it has 0 or >1 attachments. IDK WTF this is.');
                } else {
                    var img = document.createElement('img'); //start img download ASAP
                    img.onerror = threadImgAltLoader;
                    //"u/0" the 0 is sessionIndex, it separates simultanious logins into GV, 0 is most
                    //common, second login is 1, this determines what google.com cookie
                    //is used for voice.google.com images, if the browser
                    //google.com cookie doesn't match the copy pasted creds (auth token)
                    //then the alt image loader is used where the image is fetched
                    //with a token used to get the chat log, not a cookie
                    img.src = 'https://voice.google.com/u/'+userIndex+'/a/i/'+msgObj.mms_message.attachment[0].id+'?s=1';
                    var a = document.createElement('a');
                    //GV Web always shows size 3 (in url 4) (1280px), not original size 0 (in url 1)
    //0: {size_spec: "ORIGINAL", width: 11, height: 10}
    //1: {size_spec: "S_128", width: 11, height: 10}
    //2: {size_spec: "S_512", width: 11, height: 10}
    //3: {size_spec: "S_1280", width: 11, height: 10}
                    a.href = 'https://voice.google.com/u/'+userIndex+'/a/i/'+msgObj.mms_message.attachment[0].id+'?s=1';
                    a.target = '_blank';
                    a.appendChild(img);
                    p.appendChild(a);
                }
            }
            frag.insertBefore(p, frag.firstChild);
            if(msgObj.is_artificial_error_message) {
                p.style.backgroundColor = 'red'
            } else {
                p.style.outline = '1px solid black'
            }
            p.align = msgObj.type == "SMS_IN" ? 'left' : 'right';
            //an empty body MMS msg has as "plain text" content
            //"message_text": "MMS Received"
            //just always use MMS specific body if MMS
            p.appendChild(document.createTextNode(
                msgObj.mms_message ? msgObj.mms_message.text : msgObj.message_text
            ));
        }
        document.getElementById('buddy-bar').firstChild.textContent = r.thread.contact[0].name+'-';
        }
        var tdiv = document.getElementById('thread');
        while (tdiv.lastChild) {
            tdiv.removeChild(tdiv.lastChild);
        }
        tdiv.appendChild(frag);
        });
}
function hashChangeHandler () {
    var t = location.hash;
    var divBuddyBar = document.getElementById('buddy-bar');

    //https://jsperf.com/innerhtml-vs-removechild/15
    while (divBuddyBar.lastChild) {
        divBuddyBar.removeChild(divBuddyBar.lastChild);
    }
    if(t != '' && t != '#') {
        t = t.substring(1); //strip front off '#', its now only USA area+7
        getConvoUI(t);//get this req ASAP on wire before paints
        var f = document.createDocumentFragment();
        f.appendChild(document.createElement('span')); //Contact Name tag, empty RN
        var e = document.createElement('span');
        e.appendChild(document.createTextNode(t));
        f.appendChild(e);
        e = document.createElement('button');
        e.wvnum = t;
        e.innerText = "Call";
        e.addEventListener('click', function (evt){
            evt = evt.target;
            evt.innerText = "Calling";
            mkCall(evt.wvnum, function(err){
                if(err == false){
                    evt.innerText = "Called \u2714";
                } else {
                    evt.innerText = "Called \u2718";
                }
            });
        });
        f.appendChild(e);
        divBuddyBar.appendChild(f);
    } else {
        divBuddyBar.appendChild(document.createElement('span'));
        divBuddyBar.appendChild(document.createElement('span')).textContent = "no num specified in url anchor";
    }
}
hashChangeHandler();
window.addEventListener('hashchange', hashChangeHandler, false);
drawLoginBar();
</script>
<textarea id="msg" placeholder="Type outgoing msg here"></textarea>
<br/>
<button onclick="document.getElementById('msg').value=''">&nbsp;&#x2716;&nbsp;</button>
<button onclick="sendUI(event)">&nbsp;&#x2709;&nbsp;&nbsp;&nbsp;&nbsp;</button>
<button onclick="getConvoUI(location.hash.substring(1))">&nbsp;&#x25BD;&nbsp;</button>
<br/>
<label for="ipk">Choose attachment:</label>
<button onclick="clearPrvImg()">Clear Img</button>
<input id="ipk" type="file" accept="image/*" onchange="loadFile(event)">
<br/>
<img id="prv"/>
<script>
  var loadFile = function(evt) {
    var reader = new FileReader();
    reader.onload = function(){
      var output = document.getElementById('prv');
      output.src = reader.result;
    }
    reader.readAsDataURL(evt.target.files[0]);
  };
function clearPrvImg() {
    document.getElementById('ipk').value=null;
    var i = document.getElementById('prv');
    var s = i.nextSibling;
    var p = i.parentNode;
    p.removeChild(i).removeAttribute('src');
    //ASOP but not Chrome requires cloneNode to get rid of the image
    //on the image element, removing src attribute has no effect, setting src
    //to empty string causes a "corrupt" image icon in ASOP, detach and reattach
    //node doesn't remove the img, only cloneNode works (AKA new node)
    p.insertBefore(i.cloneNode(), s);
}
function sendUI(b) { //b button
    b = b.target;
    var t = location.hash.substring(1);
    //for now if no number, "invalid argument" error from API
    //if(t != "no num specified in url anchor"){
        t == "no num specified in url anchor" && (t = '');
        var b64 = document.getElementById('prv').src;
        if(b64){
            var b64StartPos = b64.indexOf(',');
            if(b64StartPos == -1){
                alert("Image selected could not be turned into a DATA URL");
                b64 = ''
            } else {
                b64 = b64.substr(b64StartPos+1);
            }
        }
        b.innerText = "\xa0\u2709\u231B\xa0"; //hourglass mark
        var msgElem = document.getElementById('msg');
        sendsms(t,msgElem.value,b64,function(err){
            if (err) {
                b.innerText = "\xa0\u2709\u2718\xa0"; //X mark
            } else {
                msgElem.value = '';
                clearPrvImg();
                b.innerText = "\xa0\u2709\u2714\xa0"; //Good mark
            }
        });
    //} else { //no tel num given
    //    b.innerText = "\xa0\u2709\u2718\xa0"; //X mark
    //}
}

function threadImgAltLoader(e) {
    //err event to img tag
    e = e.target;
    //stop infinite recursion on img tag
    e.onerror = undefined;
    //get anchor tag
    e = e.parentNode;
    var id = e.href;
    //get original id (scope/closure/leakage control), this func nvr sup 2 b
    //called anyways bc user supposed 2 have right cookies for right account
    //attached to google.com cookie store, if 2 diff browsers or incognito used
    //this alt loader will be loading all the pics tho
    id = id.substring(id.lastIndexOf('/')+1,id.lastIndexOf('?'));
    //use max quality/size aka 1 just like direct links primary method
    attachIDtoB64(id, 1, function(errTwo, r){
        //broken on newer Chrome, opens blank window
        //no top level navigation to data URL, TODO blob URL
        if (!errTwo) {
//let user save to disk or zoom in/out on it if they want thru anchor tag
            e.href = 'data:image/jpeg;base64,'+r;
            //apply to image tag
            e.firstChild.src = e.href;
        }
    });
}
</script>
</body></html>
