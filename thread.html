<html><head><meta name="mobileoptimized" content="0"></head>
<body>
<script src="/client.js" type="text/javascript"></script>
Welcome To Whogle Voice
<div id='sign-in-bar'></div>
<div id='buddy-bar'></div>
<script>
function hashChangeHandler () {
    var t = location.hash;
    var divBuddyBar = document.getElementById('buddy-bar');
    while (divBuddyBar.firstChild) {
        divBuddyBar.removeChild(divBuddyBar.firstChild);
    }
    if(t != '' && t != '#') {
        t = t.substring(1); //strip front off '#', its now only USA area+7
        divBuddyBar.appendChild(document.createTextNode(t));
        var buttonNode = divBuddyBar.appendChild(document.createElement('button'));
        buttonNode.wvnum = t;
        buttonNode.innerText = "Call";
        buttonNode.addEventListener('click', function (evt){
            evt = evt.target;
            evt.innerText = "Calling";
            mkCall(evt.wvnum, function(err){
                if(err == false){
                    evt.innerText = "Called \u2714";
                } else {
                    evt.innerText = "Called \u2718";
                }
            });
        });
    } else {
        divBuddyBar.appendChild(document.createTextNode("no num specified in url anchor"));
    }
}
drawLoginBar();
hashChangeHandler();
window.addEventListener('hashchange', hashChangeHandler, false);
</script>
<textarea id="msg" placeholder="Type outgoing msg here"></textarea>
<br/>
<button onclick="document.getElementById('msg').value=''">&nbsp;&#x2716;&nbsp;</button>
<button onclick="sendUI(event)">&nbsp;&#x2709;&nbsp;&nbsp;&nbsp;&nbsp;</button>
<br/>
<label for="ipk">Choose attachment:</label>
<button onclick="clearPrvImg()">Clear Img</button>
<input id="ipk" type="file" accept="image/*" onchange="loadFile(event)">
<br/>
<img id="prv"/>
<script>
  var loadFile = function(evt) {
    var reader = new FileReader();
    reader.onload = function(){
      var output = document.getElementById('prv');
      output.src = reader.result;
    }
    reader.readAsDataURL(evt.target.files[0]);
  };
function clearPrvImg() {
    document.getElementById('ipk').value=null;
    var i = document.getElementById('prv');
    var s = i.nextSibling;
    var p = i.parentNode;
    p.removeChild(i).removeAttribute('src');
    //ASOP but not Chrome requires cloneNode to get rid of the image
    //on the image element, removing src attribute has no effect, setting src
    //to empty string causes a "corrupt" image icon in ASOP, detach and reattach
    //node doesn't remove the img, only cloneNode works (AKA new node)
    p.insertBefore(i.cloneNode(), s);
}
function sendUI(b) { //b button
    b = b.target;
    var t = document.getElementById('buddy-bar');
    t = t.firstChild.nodeValue;
    //for now if no number, "invalid argument" error from API
    //if(t != "no num specified in url anchor"){
    //if (1) {
        t == "no num specified in url anchor" && (t = '');
        var b64;
        if(b64 = document.getElementById('prv').src){
            var b64StartPos = b64.indexOf(',');
            if(b64StartPos == -1){
                alert("Image selected could not be turned into a DATA URL");
                b64 = ''
            } else {
                b64 = b64.substr(b64StartPos+1);
            }
        }
        b.innerText = "\xa0\u2709\u231B\xa0"; //hourglass mark
        var msgElem = document.getElementById('msg');
        sendsms(t,msgElem.value,b64,function(err){
            if (err) {
                b.innerText = "\xa0\u2709\u2718\xa0"; //X mark
            } else {
                msgElem.value = '';
                clearPrvImg();
                b.innerText = "\xa0\u2709\u2714\xa0"; //Good mark
            }
        });
    //} else { //no tel num given
    //    b.innerText = "\xa0\u2709\u2718\xa0"; //X mark
    //}
}
</script>
</body></html>
